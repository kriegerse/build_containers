---
build-clamv:
  stage: build
  script:
    - source build_info.sh
    - docker build --network host -f clamav/Dockerfile
      --build-arg FS_BASE=clamav
      -t $docker_username/clamav-stage:$BUILD_PRIMARY_TAG .
    - docker push $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
    - docker image ls
    - for i in $BUILD_SECONDARY_TAGS ; do
        docker tag $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
        $docker_username/clamav-stage:$i ;
        docker push $docker_username/clamav-stage:$i ; done
  only:
    changes:
      - clamav/*
      - clamav/**/*


test-clamav:
  stage: test
  services:
    - name: kriegerse/clamav-stage:commit-$CI_COMMIT_SHORT_SHA
      alias: clamav
  image: kriegerse/clamav-stage:commit-$CI_COMMIT_SHORT_SHA
  before_script: []
  script:
    - source build_info.sh
    - bash clamav/tests/clamd_eicar.sh
  only:
    changes:
      - clamav/*
      - clamav/**/*


publish-clamav:
  stage: publish
  script:
    - source build_info.sh
    - docker pull $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
    - docker image ls
    - for i in $RELEASE_PRIMARY_TAG $RELEASE_SECONDARY_TAGS ; do
        docker tag $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
        $docker_username/clamav:$i ;
        docker push $docker_username/clamav:$i ; done
  only:
    # changes:
    #   - clamav/*
    #   - clamav/**/*
    refs:
      - web
      - master
      - schedules
  # except:
  #   - branches
