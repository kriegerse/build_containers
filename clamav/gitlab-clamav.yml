---
# build-clamv:
#   stage: build
#   script:
#     - source build_info.sh
#     - docker build --network host -f clamav/Dockerfile
#       --build-arg FS_BASE=clamav
#       -t $docker_username/clamav-stage:$BUILD_PRIMARY_TAG .
#     - docker push $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
#     - docker image ls
#     - for i in $BUILD_SECONDARY_TAGS ; do
#         docker tag $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
#         $docker_username/clamav-stage:$i ;
#         docker push $docker_username/clamav-stage:$i ; done
#   only:
#     changes:
#       - clamav/*

test-clamav:
  stage: test
  services:
    - docker:dind
  variables:
    BUILD_PRIMARY_TAG: commit-6dad18c5
  script:
    # - source build_info.sh
    - docker pull $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
    - docker run -d -P --name clamav-stage_$BUILD_PRIMARY_TAG
      $docker_username/clamav-stage:$BUILD_PRIMARY_TAG
    - docker ps -a
    - docker port clamav-stage_$BUILD_PRIMARY_TAG 3310/tcp
    - netstat -tulpn
    - which nc
    - ip a
    - export docker_port=$(docker port clamav-stage_$BUILD_PRIMARY_TAG
      3310/tcp | cut -d ':' -f 2)
    - echo $docker_port
    - echo 'PING' | nc 127.0.0.1 $docker_port
  only:
    changes:
      - clamav/*


# test-clamav:
#  stage: test
# publish-clamav:
#   stage: publish
#   script:
#     - docker pull
#     - docker image ls
#     - docker image ls $docker_username/clamav-stage:gitlabtest
